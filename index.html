<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightDeck - Airline Reservation System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="theme.js"></script>
</head>
<body>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <i class="fas fa-plane"></i>
            FlightDeck
        </a>
        <div class="navbar-links">
            <span id="user-info" style="display: none;"></span>
            <span id="auth-links">
                <a href="/register.html" class="nav-btn nav-btn-register">
                    <i class="fas fa-user-plus"></i>
                    <span>Sign Up</span>
                </a>
                <a href="/login.html" class="nav-btn nav-btn-login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </a>
            </span>
            <div class="theme-toggle" title="Toggle theme (Ctrl+Shift+L)">
                <div class="theme-toggle-slider">
                    <i class="fas fa-moon"></i>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <h1>Welcome to FlightDeck</h1>
        <p class="subtitle">Your journey begins here. Search and book flights with ease.</p>
    </div>

    <main class="main-container">

        <div class="search-card">
            <form id="search-form">
                <div class="search-grid">
                    <div class="form-group">
                        <label for="from-input">From</label>
                        <input type="text" id="from-input" class="form-control" placeholder="Airport Code (e.g., MAA)">
                    </div>
                    <div class="form-group">
                        <label for="to-input">To</label>
                        <input type="text" id="to-input" class="form-control" placeholder="Airport Code (e.g., DEL)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Search Flights
                    </button>
                </div>
            </form>
        </div>

        <div class="sort-controls">
            <label>Sort by:</label>
            <button class="btn-sort" data-sort="price-asc">
                <i class="fas fa-sort-amount-down"></i> Price: Low to High
            </button>
            <button class="btn-sort" data-sort="price-desc">
                <i class="fas fa-sort-amount-up"></i> Price: High to Low
            </button>
            <button class="btn-sort" data-sort="time">
                <i class="fas fa-clock"></i> Departure Time
            </button>
            <button class="btn-sort" data-sort="duration">
                <i class="fas fa-hourglass-half"></i> Duration
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-plane-departure"></i>
                </div>
                <div class="stat-details">
                    <h4>Available Flights</h4>
                    <p id="total-flights">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-details">
                    <h4>Starting From</h4>
                    <p id="min-price">₹0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="fas fa-route"></i>
                </div>
                <div class="stat-details">
                    <h4>Routes Available</h4>
                    <p id="routes-count">0</p>
                </div>
            </div>
        </div>

        <div class="flights-table">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Flight Number</th>
                            <th>From</th>
                            <th>To</th>
                            <th class="sortable" data-column="departure">Departure <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="arrival">Arrival <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="price">Price <i class="fas fa-sort"></i></th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="flights-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center;">
                                <div class="loading-spinner"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="flights-cards-container"></div>
    </main>

    <script>
        const userInfo = document.getElementById('user-info');
        const authLinks = document.getElementById('auth-links');
        const tableBody = document.getElementById('flights-table-body');
        const searchForm = document.getElementById('search-form');
        const fromInput = document.getElementById('from-input');
        const toInput = document.getElementById('to-input');
        let currentFlights = []; // Store current flights for sorting

        function fetchAndDisplayFlights(url) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    currentFlights = data; // Store for sorting
                    displayFlights(data);
                })
                .catch(error => console.error('Error fetching flights:', error));
        }

        function displayFlights(data) {
            tableBody.innerHTML = '';
            const isLoggedIn = userInfo.dataset.isLoggedIn === 'true';

                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">✈️</div>
                                        <h3>No flights found</h3>
                                        <p>Try adjusting your search criteria</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        document.getElementById('flights-cards-container').innerHTML = '';
                        updateStats(data);
                        return;
                    }

                    const cardsContainer = document.getElementById('flights-cards-container');
                    cardsContainer.innerHTML = '';

                    data.forEach(flight => {
                        let row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${flight.flight_number}</td>
                            <td>${flight.departure_airport_code}</td>
                            <td>${flight.arrival_airport_code}</td>
                            <td>${formatDateTime(flight.departure_time)}</td>
                            <td>${formatDateTime(flight.arrival_time)}</td>
                            <td class="flight-price">₹${flight.base_price.toLocaleString()}</td>
                            <td>
                                <button class="btn ${isLoggedIn ? 'btn-primary' : 'btn-secondary'} btn-sm book-btn"
                                        data-flight-id="${flight.flight_id}"
                                        ${!isLoggedIn ? 'disabled' : ''}>
                                    <i class="fas fa-ticket-alt"></i>
                                    ${isLoggedIn ? 'Book Now' : 'Login to Book'}
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);

                        // Create card for mobile view
                        let card = document.createElement('div');
                        card.className = 'flight-card';

                        // Calculate duration
                        const duration = new Date(flight.arrival_time) - new Date(flight.departure_time);
                        const hours = Math.floor(duration / (1000 * 60 * 60));
                        const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                        const durationText = `${hours}h ${minutes}m`;

                        card.innerHTML = `
                            <div class="flight-header">
                                <span class="flight-number">${flight.flight_number}</span>
                                <span class="flight-price">₹${flight.base_price.toLocaleString()}</span>
                            </div>
                            <div class="flight-route">
                                <div>
                                    <div class="airport-code">${flight.departure_airport_code}</div>
                                    <div>${formatDateTime(flight.departure_time)}</div>
                                </div>
                                <div style="text-align: center; flex: 0 0 auto;">
                                    <i class="fas fa-arrow-right flight-arrow"></i>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${durationText}</div>
                                </div>
                                <div>
                                    <div class="airport-code">${flight.arrival_airport_code}</div>
                                    <div>${formatDateTime(flight.arrival_time)}</div>
                                </div>
                            </div>
                            <button class="btn ${isLoggedIn ? 'btn-primary' : 'btn-secondary'} book-btn"
                                    data-flight-id="${flight.flight_id}"
                                    ${!isLoggedIn ? 'disabled' : ''} style="width: 100%;">
                                <i class="fas fa-ticket-alt"></i>
                                ${isLoggedIn ? 'Book Now' : 'Login to Book'}
                            </button>
                        `;
                        cardsContainer.appendChild(card);
                    });

            updateStats(data);
        }

        function sortFlights(sortType) {
            let sorted = [...currentFlights];

            switch(sortType) {
                case 'price-asc':
                    sorted.sort((a, b) => a.base_price - b.base_price);
                    break;
                case 'price-desc':
                    sorted.sort((a, b) => b.base_price - a.base_price);
                    break;
                case 'time':
                    sorted.sort((a, b) => new Date(a.departure_time) - new Date(b.departure_time));
                    break;
                case 'duration':
                    sorted.sort((a, b) => {
                        const durationA = new Date(a.arrival_time) - new Date(a.departure_time);
                        const durationB = new Date(b.arrival_time) - new Date(b.departure_time);
                        return durationA - durationB;
                    });
                    break;
                case 'departure':
                    sorted.sort((a, b) => new Date(a.departure_time) - new Date(b.departure_time));
                    break;
                case 'arrival':
                    sorted.sort((a, b) => new Date(a.arrival_time) - new Date(b.arrival_time));
                    break;
                case 'price':
                    sorted.sort((a, b) => a.base_price - b.base_price);
                    break;
            }

            displayFlights(sorted);
        }
        
        function logoutUser(event) {
            event.preventDefault();
            fetch('/api/logout', { method: 'POST' })
                .then(() => window.location.reload());
        }

        window.onload = function() {
            fetch('/api/session_status')
                .then(res => res.json())
                .then(data => {
                    if (data.logged_in) {
                        userInfo.innerHTML = `<i class="fas fa-user-circle"></i> <span>${data.name}</span>`;
                        userInfo.style.display = 'flex';
                        userInfo.dataset.isLoggedIn = 'true';
                        authLinks.innerHTML = `
                            <a href="/my_bookings.html" class="nav-btn nav-btn-bookings">
                                <i class="fas fa-ticket-alt"></i>
                                <span>My Bookings</span>
                            </a>
                            <a href="#" id="logout-link" class="nav-btn nav-btn-logout">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        `;
                        document.getElementById('logout-link').addEventListener('click', logoutUser);
                    } else {
                        userInfo.style.display = 'none';
                        userInfo.dataset.isLoggedIn = 'false';
                    }
                    fetchAndDisplayFlights('/api/flights');
                });
        };

        tableBody.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('book-btn')) {
                const flightId = event.target.dataset.flightId;
                fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ flight_id: flightId })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Booking successful! Your booking ID is ${data.booking_id}`, 'success');
                        setTimeout(() => {
                            window.location.href = '/my_bookings.html';
                        }, 2000);
                    } else {
                        showNotification(`Error: ${data.error}`, 'error');
                    }
                });
            }
        });
        
        searchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const from = fromInput.value.toUpperCase();
            const to = toInput.value.toUpperCase();

            let apiUrl = '/api/flights?';
            if (from) apiUrl += `from=${from}&`;
            if (to) apiUrl += `to=${to}`;
            
            fetchAndDisplayFlights(apiUrl);
        });

        // Add sort button listeners
        document.querySelectorAll('.btn-sort').forEach(button => {
            button.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.btn-sort').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const sortType = this.dataset.sort;
                sortFlights(sortType);
            });
        });

        // Add table header sorting
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.column;

                // Toggle sort direction
                const currentSort = this.dataset.sort || 'asc';
                const newSort = currentSort === 'asc' ? 'desc' : 'asc';
                this.dataset.sort = newSort;

                // Update sort icons
                document.querySelectorAll('.sortable i').forEach(icon => {
                    icon.className = 'fas fa-sort';
                });
                this.querySelector('i').className = newSort === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';

                // Sort based on column and direction
                if (column === 'price') {
                    sortFlights(newSort === 'asc' ? 'price-asc' : 'price-desc');
                } else {
                    sortFlights(column);
                }
            });
        });

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const options = {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleString('en-US', options);
        }

        function updateStats(flights) {
            document.getElementById('total-flights').textContent = flights.length;

            if (flights.length > 0) {
                const prices = flights.map(f => f.base_price);
                const minPrice = Math.min(...prices);
                document.getElementById('min-price').textContent = `₹${minPrice.toLocaleString()}`;

                const routes = new Set(flights.map(f => `${f.departure_airport_code}-${f.arrival_airport_code}`));
                document.getElementById('routes-count').textContent = routes.size;
            } else {
                document.getElementById('min-price').textContent = '₹0';
                document.getElementById('routes-count').textContent = '0';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</body>
</html>